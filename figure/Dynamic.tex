
% -----------------------------------------------------------------------------
% Dynamic Semantics
% -----------------------------------------------------------------------------

\begin{figure*}
$
\begin{array}{cl}

% -- Fire -----------------------------
\fbox{$\jFire{Auth}{Store}{Rule}{Facts}{Factoids}{Factoids}{Store}$}
\\[2ex]
\ruleI
{ \begin{array}{ll}
        \jMatches{N}{A_{sub}}{S}{\cdot}
                 {H^m}
                 {F_{read}^r}{D_{spend}^s}{A_{gain}}{E}
  \quad  \jStoreDown{S}{D_{spend}^s}{S'}
  \\[1ex]
        \jEval{E}{M}{D_{new}^n}
  \quad \bigwedge \{ A_{gain} \supseteq \trm{auth-by}~D~|~D \in D_{new}^n \}
  \hspace{1.8em} \jStoreUp{S'}{D_{new}^n}{S''}
  \end{array}
}
{\jFire {A_{sub}}{S}
        {\krule~N~\kawait~H^m~\kto~M}
        {F_{read}^r}{D_{spend}^s}{D_{new}^n}{S''}
}
& (\trm{EvFire})
\\[3ex]


% -- matches --------------------------
\fbox{$\jMatches{Name}{Auth}{Store}{Env}{Matches}{Facts}{Factoids}{Auth}{Env}$}
\\[2ex]

\jMatches{N}{A}{S}{E}{\cdot}{\emptyset}{\emptyset}{\emptyset}{E}
& (\trm{EvMatchNil})
\\[2ex]

\ruleI
{ \begin{array}{ll}
       \jMatch  {N_{rule}}{A_{sub}}{S~}{E~}
                {H~~}
                {F}{D}{A_{gain}}{E'}
  \\[0.5ex]
       \jMatches{N_{rule}}{A_{sub}}{S}{E'}
                {H^n}
                {F^e}{D^s}{A_{gain}'}{E''}
  \end{array}
}
{       \jMatches{N_{rule}}{A_{sub}}{S}{E}
                {H ~ H^n}
                {\{F\} \cup F^e}
                {\{D\} \uplus D^s}
                {A_{gain} \cup A_{gain}'}
                {E''}
}
& (\trm{EvMatchCons})
\\[3ex]


% -- match ----------------------------
\fbox{$\jMatch{Name}{Auth}{Store}{Env}{Match}{Fact}{Factoid}{Auth}{Env}$}
\\[2ex]

\ruleI
{ \begin{array}{rl}
  &     E' = E, X \mapsto F
  \\    \jSelect  {F^n}{E}{X ~;~ C}{F~~}
  &     \jConsume {N_{rule}}{F}{E'}{U}{W_{spend}}
  \\    \jGather  {A_{sub}} {S}{E} {X ~;~ N_{fact} ~;~ M}{F^n}
  &     \jGain    {N_{rule}}{F}{E'}{I}{A_{gain}}
  \end{array}
}
{ \begin{array}{rl}
          N_{rule} ~|~ A_{sub} ~|~ S ~|~ E \hspace{-1ex}
        & \vdash \hspace{1ex} X~
                \kfrom~    N_{fact}~
                \kwhere~   M~
                \kselect~  C~
                \kconsume~ U~
                \kgain~    I
        \\ & \Rightarrow F ~|~ (F,~ W_{spend}) ~|~ A_{gain} ~|~ E'
  \end{array}
}
& (\trm{EvMatchOne})
\\[4ex]


% -- gather ----------------------------
\fbox{$\jGather{Auth}{Store}{Env}{Var ~;~ Name ~;~ Term}{Facts}$}
\\[2ex]

\ruleI
{ F^n = \left \{
  \begin{array}{rll}
        F & |~~ F \in \trm{dom}~ S
     \\    & ,~~ \trm{name}~ F = N_{fact}
             ,~~ \trm{sees}~ A_{sub}~ F
     \\    & ,~~ (\jEval{E,~X \mapsto F}{M}{\ktrue})
     \end{array}
  \right \}
}
{   \jGather{A_{sub}}{S}{E}{X ~;~ N_{fact} ~;~ M}{F^n}
}
& (\trm{EvGather})
\\[3ex]


%% -- select ---------------------------
\fbox{$\jSelect{Facts}{Env}{Var ~;~ Select}{Fact}$}
\\[2ex]

\ruleI
{ F \in F^n }
{ \jSelect{F^n}{E}{X ~;~ \kany}{F} }
\qq
\ruleI
{ \begin{array}{c}
  D^m = \{ (V, F) ~|~ F \in F^n, (\jEval{E, X \mapsto F}{M}{V} ) \}
  \\
  V' = \trm{minimum}~ \{ V ~|~ (V, \_) \in D^m \}
  \qq (F', V')  \in D^m
  \end{array}
}
{ \jSelect{F^n}{E}{X ~;~ \kfirst~ M}{F'} }
& (\trm{EvAny/First})
\\[3ex]


%% -- consume --------------------------
\fbox{$\jConsume{Name}{Fact}{Env}{Consume}{Weight}$}
\\[2ex]
        \jConsume{N_{rule}}{F}{E}{\knone}{0}
\qq
\ruleI
{       N_{rule} \in \trm{rules}~ F
 \qq    \jEval{E}{M}{W}
}
{       \jConsume{N_{rule}}{F}{E}{M}{W}
}
& (\trm{EvConsumeNone/Some})
\\[3ex]


%% -- gain ----------------------------
\fbox{$\jGain{Name}{Fact}{Env}{Gain}{Auth}$}
\\[2ex]
        \jGain{N_{rule}}{F}{E}{\knone}{\emptyset}
\qq
\ruleI
{       N_{rule} \in \trm{rules}~ F
 \quad  \jEval{E}{M}{A}
 \quad  A \subseteq \trm{auth-by}~ F
}
{       \jGain{N_{rule}}{F}{E}{M}{A}
}
& (\trm{EvGainNone/Some})
\\[3ex]


%% -- eval ----------------------------
\fbox{$\jEval{Env}{Term}{Value}$}

\\[2ex]
\ruleI
{       F = (N_{fact}, V_{payload}, A_{by}, A_{obs}, V_{use})
  \quad \jEval{E}{M_{payload}}{V_{payload}}
  \quad \dots
}
{       \jEval {E}
                {\ksay~ N_{fact}~ M_{payload}~ M_{by}~ M_{obs}~ M_{use}~ M_{num}}
                {(F,~ V_{num})}
}
& (\trm{EvSay})

\end{array}
$
\caption{Dynamic Semantics}
\label{f:Dynamics}
\end{figure*}



