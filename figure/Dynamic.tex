
% -----------------------------------------------------------------------------
% Dynamic Semantics
% -----------------------------------------------------------------------------

\begin{figure*}
$$
\begin{array}{cl}

% -- Fire -----------------------------
\fbox{$\jFire{Auth}{Store}{Rule}{Factoids}{Factoids}{Store}$}
\\[2ex]
\ruleI
{ \begin{array}{ll}
  &  \bigwedge \{ A_{has} \supseteq \trm{auth-by}~D~|~D \in D_{new}^m \}
  \\[1ex] \jMatches{N}{A_{sub}}{S}{\cdot}{H^n}{A_{has}}{D_{spent}^n}{E'}
  &  ~~~ \jEval{E'}{M}{D_{new}^m}
  \end{array}
}
{\jFire {A_{sub}}{S}
        {\krule~N~\kawait~H^n~\kto~M}
        {D_{spent}^n}{D_{new}^m}{(S \setminus D^n_{spent}) \uplus D_{new}^m}
}
& (\trm{EvFire})
\\[2ex]


% -- matches --------------------------
\fbox{$\jMatches{Name}{Auth}{Store}{Env}{Matches}{Auth}{Factoids}{Env}$}
\\[2ex]

\jMatches{N}{A}{S}{E}{\cdot}{\emptyset}{\emptyset}{E}
& (\trm{EvMatchNil})
\\[2ex]

\ruleI
{ \begin{array}{ll}
       \jMatch{N_{rule}}{A_{sub}}{S~}{E~}{H~~}{A_{gain}}{D_{spent}}{S'}{E'}
  \\[0.5ex]
       \jMatches{N_{rule}}{A_{sub}}{S'}{E'}{H^n}{A_{gain}'}{D_{spent}'}{E''~~~~~  }
  \end{array}
}
{ \jMatches{N_{rule}}{A_{sub}}{S}{E}{H ~ H^n}
           {A_{gain}  \cup A_{gain}'}
           {D_{spent} \cup D_{spent}'}
           {E''}
}
& (\trm{EvMatchCons})
\\[3ex]


% -- match ----------------------------
\fbox{$\jMatch{Name}{Auth}{Store}{Env}{Match}{Auth}{Factoid}{Store}{Env}$}
\\[2ex]

% -- MatchGuard
\ruleI
{ \begin{array}{ll}
     \jGather{A_{sub}}{S}{E}{X ~;~ N_{fact} ~;~ M_{pred}}{F^n}
  &
  \\ \hspace{8.2em}     \jSelect{F^n}{E}{X ~;~ C}{F~~}
  &  E' = E, X \mapsto F
  \\ \hspace{4.8em}     \jConsume{F}{S}{E'}{M_{num}}{W}{S'}
  &  N_{rule} \in \trm{rules}~ F
  \\ \hspace{6.2em}       \jGain{F}{E'}{M_{gain}}{A_{gain}}
  &
  \end{array}
}
{   \jMatch
        {N_{rule}}{A_{sub}}{S}{E}
        {\begin{array}{ll}
          X~\kfrom~ N_{fact}~ ~\kwhere~ M_{pred}~
            \\ \hspace{1em} \kselect~ C~ \kconsume~ M_{num}~
            \\ \hspace{1em} \kgain~ M_{gain}
         \end{array}
        }
        {A_{gain}}{(F,W)}{S'}{E'}
}
& (\trm{EvMatch})
\\[5ex]


% -- gather ----------------------------
\fbox{$\jGather{Auth}{Store}{Env}{Var ~;~ Name ~;~ Term}{Facts}$}
\\[2ex]

\ruleI
{ F^n = \left \{
  \begin{array}{rll}
        F & |~~ (F \mapsto W) \in S
     \\    & ,~~ \trm{name}~ F = N_{fact}
             ,~~ \trm{sees}~ A_{sub}~ F
             ,~~  W \geq 1
     \\    & ,~~ (\jEval{E,~X \mapsto F}{M}{\ktrue})
     \end{array}
  \right \}
}
{   \jGather{A_{sub}}{S}{E}{X ~;~ N_{fact} ~;~ M}{F^n}
}
& (\trm{EvGather})
\\[3ex]


%% -- select ---------------------------
\fbox{$\jSelect{Facts}{Env}{Var ~;~ Select}{Fact}$}
\\[2ex]

\ruleI
{ F \in F^n }
{ \jSelect{F^n}{E}{X ~;~ \kany}{F} }
\qq
\ruleI
{ \begin{array}{c}
  D^m = \{ (V, F) ~|~ F \in F^n, (\jEval{E, X \mapsto F}{M}{V} ) \}
  \\
  V' = \trm{minimum}~ \{ V ~|~ (V, \_) \in D^m \}
  \qq (F', V')  \in D^m
  \end{array}
}
{ \jSelect{F^n}{E}{X ~;~ \kfirst~ M}{F'} }
& (\trm{EvAny/First})
\\[3ex]


%% -- consume --------------------------
\fbox{$\jConsume{Fact}{Store}{Env}{Consume}{Weight}{Store}$}
\\[2ex]

\ruleI
{     \jEval{E}{M}{W_{need}}
  \qq W_{avail} \geq W_{need}
}
{ \jConsume
        {F}{S[F \mapsto W_{avail}]}{E}
        {\kconsume~ M}
        {W_{need}}{S[F \mapsto W_{avail} - W_{need}]}
}
& (\trm{EvConsume})
\\[3ex]


%% -- gain ----------------------------
\fbox{$\jGain{Fact}{Env}{Term}{Auth}$}
\\[2ex]
\ruleI  {       \jEval{E}{M}{A}
         \qq    A \subseteq \trm{auth-by}~ F }
        {\jGain{F}{E}{M}{A}}
& (\trm{EvGain})
\\[3ex]


%% -- eval ----------------------------
\fbox{$\jEval{Env}{Term}{Value}$}

\\[2ex]
\ruleI  {   F = (N_{fact}, V_{payload}, A_{by}, A_{obs}, V_{use})
        \quad \jEval{E}{M_{payload}}{V_{payload}}
        \quad \dots }
        {\jEval {E}
                {\ksay~ N_{fact}~ M_{payload}~ M_{by}~ M_{obs}~ M_{use}~ M_{num}}
                {(F,~ V_{num})}}
& (\trm{EvSay})
\end{array}
$$

\caption{Dynamic Semantics}
\label{f:Dynamics}
\end{figure*}
