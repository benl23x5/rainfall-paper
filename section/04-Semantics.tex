
\clearpage{}
\section{Semantics}

% ---------------------------------------------------------
\begin{figure}
\begin{small}
\begin{alltt}
Name   ::= ...
Ctor   ::= ...
Label  ::= ...

Decl   ::= rule Name Rule
Rule   ::= await Guard+ to Action
Guard  ::= Ctor as Var where Term

Type   ::= unit | text | symbol | nat | party
        |  set Type | Type \(\to\) Type

Term   ::= Var | Term Term | \(\lambda\) Var : Type \(\to\) Term
        |  [ (Label = Term)* ] | Term . Label

Value  ::= Lit | \(\lambda\) Var : Type \(\to\) Term
        |  [ (Label = Value)* ]

Action ::= done | Action ; Action
        |  say Ctor [ (Label = Exp)* ]
           by  Term  use Term  for Term  obs Term
\end{alltt}
\end{small}

\caption{Core Language Grammar}
\end{figure}


% ---------------------------------------------------------
\begin{figure*}

$$
\begin{array}{cl}

% -- Fire -----------------------------
\fbox{$\jFire{Auth}{Store}{Rule}{Factoids}{Factoids}{Store}$}
\\[2ex]
\ruleI
{ \begin{array}{ll}
  &  \bigwedge \{ A_{has} \supseteq \trm{auth-by}~D~|~D \in D_{new}^m \}
  \\[1ex] \jMatches{N}{A_{sub}}{\cdot}{S}{G^n}{A_{has}}{D_{spent}^n}{S'}{E'}
  &  ~~~ \jExec{E'}{M}{\kunit}{D_{new}^m}
  \end{array}
}
{\jFire {A_{sub}}{S}
        {\krule~N~\kawait~G^n~\kto~M}
        {D_{spent}^n}{D_{new}^m}{S' \uplus D_{new}^m}
}
& (\trm{Fire})
\\[4ex]


% -- match ----------------------------
\fbox{$\jMatch{Auth}{Env}{Store}{Guard}{Auth}{Env}{Store}$}
\\[2ex]

% -- MatchGuard
\ruleI
{ \begin{array}{ll}
     E''   = E,~X\mapsto~\krecord~E'
  &  A \supseteq A_\iby \cup A_\iobs
  \\ S'' \ = S' [\ C~E'~A_{\iby}~A_{\iobs}~A_{\ifor}~M_{\iuse}~\mapsto~0 \ ]
  &  ~~ \jEval{\cdot}{M_\iuse~(\kauth~A)}{\ktrue}
  \\ S~~ \ = S' [\ C~E'~A_{\iby}~A_{\iobs}~A_{\ifor}~M_{\iuse}~\mapsto~1 \ ]
  &  \jEval{E''}{M}{\ktrue} \qq A' = A \cup A_\ifor
  \end{array}
}
{   \jMatch{A}{E}{S}{C~\kas~X~\kwhere~M}{A'}{E''}{S''}
}
& (\trm{Match})
\\[4ex]


% -- Matches ---------------------------
% \fbox{$\jMatches{Auth}{Env}{Store}{Guard}{Auth}{Env}{Store}$}
% \\[2ex]

% -- MatchNil
% \ruleI
% { }
% {\jMatches{A}{E}{S}{\cdot}{A}{E}{S}
% }
% & (\trm{MatchesNil})
% \\[2ex]

% -- MatchCons
% \ruleI
% {   \jMatch  {A}{E}{S}{G}{A'}{E'}{S'}
% \qq \jMatches{A'}{E'}{S'}{Gs}{A''}{E''}{S''}
% }
% {   \jMatches{A}{E}{S}{G,~Gs}{A''}{E''}{S''}}
% & (\trm{MatchesCons})
% \\[4ex]


% -- runs -----------------------------
% \fbox{$\jRun{Auth}{Env}{Action}{Store}$}
% \\[2ex]




\end{array}
$$

\caption{Operational Semantics}
\end{figure*}


\begin{figure}
\begin{small}
\begin{alltt}
fact  Coin   [stamp: Symbol, holder: Party]
fact  Offer  [id: Symbol, giver: Party, receiver: Party]
fact  Accept [id: Symbol, accepter: Party]

node  Bank

rule  transfer
await Accept  as accept
 and  Offer   as offer
      where   accept.id       == offer.id,
              accept.accepter == offer.receiver
 and  Coin    as coin
      where   coin.holder     == offer.giver
to
      say Coin [ stamp  = coin.stamp
               , holder = offer.receiver]
      by  [auth| Bank, offer.receiver]
      use (elem offer.receiver)

scenario Bank, Alice, Bob
to do say Coin   [ stamp = 'Coin1001, holder = Alice]
      by  [auth| Bank, Alice]
      use (elem Alice)

      say Offer  [ id    = '1234
                 , giver = Alice, receiver = Bob]
      by  Alice use (elem Bob)

      say Accept [ id = '1234,    accepter = Bob]
      by  Bob   use (const true)
\end{alltt}
\end{small}

\caption{Coin Transfer Workflow}
\label{f:CoinTransferDesugared}
\end{figure}
